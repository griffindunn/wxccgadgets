(function(){const V="v4.0-Final";const S=`:host{color-scheme:light dark;--bg-app:#fff;--bg-card:#fff;--bg-header:#fcfcfc;--bg-input:#fff;--bg-shift-row:#f9f9f9;--bg-shift-row-hover:#eef9fd;--bg-edit-box:#f0fbff;--bg-new-area:#fafafa;--text-main:#333;--text-sub:#555;--text-desc:#777;--text-input:#333;--border-color:#dcdcdc;--border-light:#eee;--border-accent:#00bceb;--color-primary:#00bceb;--color-primary-hover:#00a0c6;--color-success:#2fb16c;--color-danger:#dc3545;display:block;font-family:"CiscoSans","Helvetica Neue",Helvetica,Arial,sans-serif;background-color:var(--bg-app);color:var(--text-main);height:100%;overflow-y:auto;padding:20px;box-sizing:border-box;}@media(prefers-color-scheme:dark){:host{--bg-app:#121212;--bg-card:#1e1e1e;--bg-header:#252525;--bg-input:#2c2c2c;--bg-shift-row:#2a2a2a;--bg-shift-row-hover:#333;--bg-edit-box:#2c3e50;--bg-new-area:#222;--text-main:#e0e0e0;--text-sub:#ccc;--text-desc:#aaa;--text-input:#fff;--border-color:#444;--border-light:#333;}}h2{color:var(--color-primary);margin:0 0 25px;font-weight:300;}h3.category-header{width:100%;margin:30px 0 15px;font-size:0.8rem;font-weight:700;text-transform:uppercase;color:var(--text-sub);border-bottom:1px solid var(--border-color);padding-bottom:8px;letter-spacing:1px;}#content{display:flex;flex-wrap:wrap;gap:20px;align-items:flex-start;padding-bottom:40px;}.var-row{background:var(--bg-card);border:1px solid var(--border-color);border-radius:8px;padding:16px;display:flex;align-items:flex-start;transition:box-shadow 0.2s;flex:0 0 auto;min-width:300px;}.var-row:hover{box-shadow:0 4px 12px rgba(0,0,0,0.08);}.var-info{flex:0 0 150px;margin-right:20px;margin-top:8px;}.var-name{font-weight:600;color:var(--text-main);font-size:0.95rem;margin-bottom:4px;display:block;}.var-desc{font-size:0.8rem;color:var(--text-desc);line-height:1.4;}.var-input-container{display:flex;gap:8px;align-items:flex-start;flex:1;}textarea.var-input,select{width:100%;padding:8px;border:1px solid var(--border-color);background-color:var(--bg-input);color:var(--text-input);border-radius:4px;font:inherit;min-height:38px;resize:both;box-sizing:border-box;}.bh-card{display:flex;flex-direction:column;background:var(--bg-card);border:1px solid var(--border-color);border-radius:8px;overflow:hidden;flex:0 0 auto;min-width:450px;}.bh-header{background:var(--bg-header);padding:15px 20px;border-bottom:1px solid var(--border-light);display:flex;justify-content:space-between;align-items:center;}.bh-title{font-size:1rem;font-weight:600;color:var(--text-main);}.bh-content{padding:0;}.bh-new-shift-area{padding:0 20px;border-bottom:1px solid var(--border-light);display:none;background-color:var(--bg-new-area);}.bh-new-shift-area.active{display:block;padding:20px;}.bh-day-group{border-bottom:1px solid var(--border-light);padding:12px 20px;}.bh-day-group:last-child{border-bottom:none;}.bh-day-name{font-size:0.85rem;font-weight:700;color:var(--text-sub);margin-bottom:8px;}.bh-day-shifts{display:flex;flex-direction:column;gap:6px;}.shift-row{display:grid;grid-template-columns:1fr 1fr;padding:8px 12px;background:var(--bg-shift-row);border-radius:4px;cursor:pointer;font-size:0.9rem;}.shift-row:hover{background:var(--bg-shift-row-hover);}.shift-row-name{color:var(--color-primary);font-weight:600;}.shift-row-time{color:var(--text-desc);text-align:right;}.shift-empty{font-size:0.85rem;color:#999;font-style:italic;padding-left:12px;}.shift-edit-box{background:var(--bg-edit-box);border:1px solid var(--border-accent);border-radius:6px;padding:15px;margin-top:8px;display:flex;flex-direction:column;gap:12px;}.bh-new-shift-area .shift-edit-box{margin-top:0;background:var(--bg-card);}.delete-confirm-view{text-align:center;padding:20px 0;animation:fadeIn 0.2s ease-in;}.edit-row{display:flex;gap:15px;flex-wrap:wrap;}.form-group{display:flex;flex-direction:column;gap:4px;}.form-label{font-size:0.7rem;font-weight:700;color:var(--text-sub);text-transform:uppercase;}.edit-name,.edit-start,.edit-end{background:var(--bg-input);color:var(--text-input);border:1px solid var(--border-color);padding:5px;border-radius:4px;}.day-pills{display:flex;gap:6px;flex-wrap:wrap;}.day-pill{padding:5px 8px;border:1px solid var(--border-color);background:var(--bg-input);color:var(--text-input);border-radius:4px;font-size:0.75rem;cursor:pointer;user-select:none;}.day-pill:hover{background:var(--border-light);}.day-pill.selected{background:var(--color-primary);color:white;border-color:var(--color-primary);}.bh-save-bar{padding:15px 20px;background:var(--bg-new-area);border-top:1px solid var(--border-color);text-align:right;display:none;}.bh-save-bar.visible{display:block;animation:slideUp 0.3s ease-out;}@keyframes slideUp{from{opacity:0;transform:translateY(10px);}to{opacity:1;transform:translateY(0);}}@keyframes fadeIn{from{opacity:0;}to{opacity:1;}}.btn{padding:0 16px;height:36px;border:none;border-radius:18px;font-weight:600;font-size:13px;cursor:pointer;transition:0.2s;}.btn-primary{background:var(--color-primary);color:white;}.btn-primary:hover{background:var(--color-primary-hover);}.btn-primary:disabled{background:#ccc;cursor:not-allowed;}.btn-success{background:var(--color-success);color:white;}.btn-success:hover{opacity:0.9;}.btn-black{background:#222;color:white;}.btn-black:hover{background:#000;}@media(prefers-color-scheme:dark){.btn-black{background:#444;}.btn-black:hover{background:#555;}}.btn-secondary{background:var(--bg-card);border:1px solid var(--border-color);color:var(--text-main);}.btn-secondary:hover{background:var(--border-light);}.btn-danger{background:var(--color-danger);color:white;}.btn-danger:hover{opacity:0.9;}.footer-version{position:fixed;bottom:8px;left:15px;font-size:11px;color:var(--text-desc);pointer-events:none;}#toast{visibility:hidden;min-width:300px;background-color:#333;color:#fff;text-align:center;border-radius:6px;padding:16px;position:fixed;z-index:1000;left:50%;bottom:30px;transform:translateX(-50%);opacity:0;transition:opacity 0.3s;}#toast.show{visibility:visible;opacity:1;bottom:50px;}#toast.success{background-color:var(--color-success);}#toast.error{background-color:var(--color-danger);}.loading{color:var(--text-desc);font-style:italic;display:flex;align-items:center;gap:8px;}`;const T=document.createElement("template");T.innerHTML="<style>"+S+'</style><div id="app"><h2>Supervisor Controls</h2><div id="debug-info" style="font-size: 0.8em; color: var(--text-desc); margin-bottom: 10px; display: none;"></div><div id="content"></div></div><div id="toast">Notification</div><div class="footer-version">'+V+"</div>";class SupervisorControls extends HTMLElement{constructor(){super();this.attachShadow({mode:"open"});this.shadowRoot.appendChild(T.content.cloneNode(true));this.ctx={token:null,orgId:null,region:null,baseUrl:null};this.data={variables:[],businessHours:[]};this.editState={};this.hasChanges={}}static get observedAttributes(){return["token","org-id","data-center"]}attributeChangedCallback(n,o,v){if(n==="token")this.ctx.token=v;if(n==="org-id")this.ctx.orgId=v;if(n==="data-center"){this.ctx.region=v;this.ctx.baseUrl=this.resolveApiUrl(v)}if(this.ctx.token&&this.ctx.orgId&&this.ctx.baseUrl){this.updateDebugDisplay();this.loadAllData()}}resolveApiUrl(d){const c=d?d.replace("prod","").toLowerCase():"us1";const m={"us1":"https://api.wxcc-us1.cisco.com","eu1":"https://api.wxcc-eu1.cisco.com","eu2":"https://api.wxcc-eu2.cisco.com","anz1":"https://api.wxcc-anz1.cisco.com","ca1":"https://api.wxcc-ca1.cisco.com"};return m[c]||m["us1"]}updateDebugDisplay(){this.shadowRoot.getElementById("debug-info").innerText=`Org: ${this.ctx.orgId} | API: ${this.ctx.baseUrl}`}async loadAllData(){const c=this.shadowRoot.getElementById("content");c.innerHTML='<div class="loading"><span>Loading Data...</span></div>';try{await Promise.all([this.loadVariables(),this.loadBusinessHours()]);this.render()}catch(e){console.error("[SupervisorControls] Load failed:",e);c.innerHTML=`<div style="color:var(--color-danger)">Error loading data: ${e.message}</div>`}}async loadVariables(){const u=`${this.ctx.baseUrl}/organization/${this.ctx.orgId}/v2/cad-variable?page=0&pageSize=100`;const r=await fetch(u,{headers:{"Authorization":`Bearer ${this.ctx.token}`}});if(!r.ok)throw new Error(`Variables API Error ${r.status}`);const j=await r.json();this.data.variables=(j.data||[]).filter(v=>v.active!==false)}async loadBusinessHours(){const u=`${this.ctx.baseUrl}/organization/${this.ctx.orgId}/v2/business-hours?page=0&pageSize=100`;const r=await fetch(u,{headers:{"Authorization":`Bearer ${this.ctx.token}`}});if(!r.ok)throw new Error(`Business Hours API Error ${r.status}`);const j=await r.json();this.data.businessHours=j.data||[];this.editState={};this.hasChanges={};this.data.businessHours.forEach(b=>{this.editState[b.id]=JSON.parse(JSON.stringify(b.workingHours||[]));this.hasChanges[b.id]=false})}escapeHtml(s){if(!s)return"";return String(s).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;")}render(){const c=this.shadowRoot.getElementById("content");c.innerHTML="";const vs=[...this.data.variables].sort((a,b)=>{if(a.variableType<b.variableType)return-1;if(a.variableType>b.variableType)return 1;return a.name.localeCompare(b.name)});let t="";vs.forEach(v=>{const T=(v.variableType||"UNKNOWN").toUpperCase();if(T!==t){t=T;c.insertAdjacentHTML("beforeend",`<h3 class="category-header">${this.escapeHtml(t)} Variables</h3>`)}c.insertAdjacentHTML("beforeend",this.buildVariableCard(v))});if(this.data.businessHours.length>0){c.insertAdjacentHTML("beforeend",`<h3 class="category-header">Business Hours</h3>`);this.data.businessHours.forEach(b=>{const s=this.editState[b.id]||[];const d=this.hasChanges[b.id];c.appendChild(this.buildBusinessHoursCard(b,s,d))})}this.attachEventListeners(c)}buildVariableCard(v){const b=(v.variableType||"").toLowerCase()==="boolean";const n=this.escapeHtml(v.name);const d=this.escapeHtml(v.description);const val=this.escapeHtml(v.defaultValue||"");const i=b?`<select id="input-${v.id}"><option value="true" ${String(v.defaultValue)==="true"?"selected":""}>TRUE</option><option value="false" ${String(v.defaultValue)==="false"?"selected":""}>FALSE</option></select>`:`<textarea id="input-${v.id}" class="var-input" rows="1">${val}</textarea>`;return`<div class="var-row"><div class="var-info"><span class="var-name">${n}</span>${v.description?`<div class="var-desc">${d}</div>`:""}</div><div class="var-input-container">${i}<button class="btn btn-primary save-var-btn" data-id="${v.id}">Save</button></div></div>`}buildBusinessHoursCard(b,s,d){const c=document.createElement("div");c.className="bh-card";const days=["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"];const short=["SUN","MON","TUE","WED","THU","FRI","SAT"];let h="";days.forEach((dn,di)=>{const dc=short[di];const as=s.map((sh,idx)=>({...sh,originalIndex:idx})).filter(sh=>sh.days&&sh.days.includes(dc)).sort((x,y)=>x.startTime.localeCompare(y.startTime));let rh="";if(as.length===0){rh=`<div class="shift-empty">No Shifts</div>`}else{rh=as.map(sh=>`<div class="shift-row" data-bh="${b.id}" data-idx="${sh.originalIndex}"><div class="shift-row-name">${this.escapeHtml(sh.name)}</div><div class="shift-row-time">${this.formatTime(sh.startTime)} - ${this.formatTime(sh.endTime)}</div></div>`).join("")}h+=`<div class="bh-day-group"><div class="bh-day-name">${dn}</div><div class="bh-day-shifts">${rh}</div></div>`});c.innerHTML=`<div class="bh-header"><div><div class="bh-title">${this.escapeHtml(b.name)}</div>${b.description?`<div class="var-desc">${this.escapeHtml(b.description)}</div>`:""}</div><button class="btn btn-black add-shift-btn" data-bh="${b.id}">Add Shift</button></div><div id="new-shift-container-${b.id}" class="bh-new-shift-area"></div><div class="bh-content">${h}</div><div class="bh-save-bar ${d?"visible":""}"><button class="btn btn-success save-bh-btn" data-bh="${b.id}">Save Changes</button></div>`;return c}attachEventListeners(r){r.querySelectorAll(".save-var-btn").forEach(b=>b.addEventListener("click",e=>this.handleSaveVariable(e.target.dataset.id,e.target)));r.querySelectorAll(".add-shift-btn").forEach(b=>b.addEventListener("click",e=>this.openAddShiftUI(e.target.dataset.bh)));r.querySelectorAll(".save-bh-btn").forEach(b=>b.addEventListener("click",e=>this.handleSaveBusinessHours(e.target.dataset.bh,e.target)));r.querySelectorAll(".shift-row").forEach(ro=>{ro.addEventListener("click",e=>{if(ro.nextElementSibling&&ro.nextElementSibling.classList.contains("shift-edit-box"))return;this.openEditShiftUI(e.currentTarget.dataset.bh,e.currentTarget.dataset.idx,e.currentTarget)})})}openAddShiftUI(id){const c=this.shadowRoot.getElementById(`new-shift-container-${id}`);if(!c)return;const d={name:"New Shift",startTime:"09:00",endTime:"17:00",days:[]};c.innerHTML=this.getShiftEditHTML(d,true);c.classList.add("active");this.attachShiftEditHandlers(c,id,-1)}openEditShiftUI(id,idx,el){const s=this.editState[id][idx];el.insertAdjacentHTML("afterend",this.getShiftEditHTML(s,false));const eb=el.nextElementSibling;el.style.display="none";eb.querySelector(".cancel-edit-btn").addEventListener("click",()=>{eb.remove();el.style.display="grid"},{once:true});this.attachShiftEditHandlers(eb,id,idx,el)}attachShiftEditHandlers(c,id,idx,el=null){const eb=c.querySelector(".shift-edit-box");eb.querySelectorAll(".day-pill").forEach(t=>{t.addEventListener("click",e=>{e.currentTarget.classList.toggle("selected");if(e.currentTarget.classList.contains("selected")){e.currentTarget.innerHTML=`&#10003; ${e.currentTarget.dataset.day}`}else{e.currentTarget.innerText=e.currentTarget.dataset.day}})});if(idx===-1){eb.querySelector(".cancel-edit-btn").addEventListener("click",()=>{c.innerHTML="";c.classList.remove("active")})}const db=eb.querySelector(".delete-shift-btn");if(db){db.addEventListener("click",()=>{const nv=eb.querySelector(".edit-normal-view");nv.style.display="none";const ch=`<div class="delete-confirm-view"><div style="margin-bottom: 15px; font-weight:600; color: var(--text-main);">Are you sure you want to delete this shift?</div><div style="display:flex; justify-content:center; gap:10px;"><button class="btn btn-secondary cancel-del-btn">No, Keep it</button><button class="btn btn-danger confirm-del-btn">Yes, Delete</button></div></div>`;eb.insertAdjacentHTML("beforeend",ch);eb.querySelector(".cancel-del-btn").addEventListener("click",()=>{eb.querySelector(".delete-confirm-view").remove();nv.style.display="block"});eb.querySelector(".confirm-del-btn").addEventListener("click",()=>{this.editState[id].splice(idx,1);this.hasChanges[id]=true;this.render()})})}eb.querySelector(".confirm-edit-btn").addEventListener("click",()=>{const n=eb.querySelector(".edit-name").value;const s=eb.querySelector(".edit-start").value;const e=eb.querySelector(".edit-end").value;const d=Array.from(eb.querySelectorAll(".day-pill.selected")).map(el=>el.dataset.day);const v=this.validateShift(n,s,e,d);if(v){this.showNotification(v,"error");return}const ts=[...this.editState[id]];const os=idx===-1?ts:ts.filter((_,i)=>i!=idx);const cf=this.checkConflicts({name:n,startTime:s,endTime:e,days:d},os);if(cf){this.showNotification(cf,"error");return}if(idx===-1){this.editState[id].push({name:n,startTime:s,endTime:e,days:d})}else{this.editState[id][idx]={name:n,startTime:s,endTime:e,days:d}}this.hasChanges[id]=true;this.render()})}getShiftEditHTML(s,isNew){const d=["SUN","MON","TUE","WED","THU","FRI","SAT"];const n=this.escapeHtml(s.name||"");const btn=isNew?'<div></div>':'<button class="btn btn-danger delete-shift-btn">Delete Shift</button>';return`<div class="shift-edit-box"><div class="edit-normal-view"><div class="edit-row"><div class="form-group"><span class="form-label">Name</span><input type="text" class="edit-name" value="${n}" style="width:180px;"></div><div class="form-group"><span class="form-label">Time Duration</span><div style="display:flex;align-items:center;gap:5px;"><input type="time" class="edit-start" value="${s.startTime}"><span>to</span><input type="time" class="edit-end" value="${s.endTime}"></div></div></div><div class="form-group" style="margin-top: 10px;"><span class="form-label">Days Active</span><div class="day-pills">${d.map(dy=>`<div class="day-pill ${s.days.includes(dy)?'selected':''}" data-day="${dy}">${s.days.includes(dy)?'&#10003;':''} ${dy}</div>`).join("")}</div></div><div style="display:flex; justify-content:space-between; margin-top:15px; border-top: 1px solid var(--border-light); padding-top: 10px;">${btn}<div style="display:flex; gap:10px;"><button class="btn btn-secondary cancel-edit-btn">Cancel</button><button class="btn btn-primary confirm-edit-btn">Done</button></div></div></div></div>`}validateShift(n,s,e,d){if(!n)return"Name is required.";if(d.length===0)return"Select at least one day.";if(!s||!e)return"Start and End times required.";if(s>=e)return"Start time must be before End time.";return null}checkConflicts(c,e){const cs=parseInt(c.startTime.replace(":",""));const ce=parseInt(c.endTime.replace(":",""));for(const d of c.days){const ds=e.filter(sh=>sh.days.includes(d));for(const ex of ds){const es=parseInt(ex.startTime.replace(":",""));const ee=parseInt(ex.endTime.replace(":",""));if(cs<ee&&ce>es){return`Overlap detected on ${d} with "${ex.name}"`}}}return null}async handleSaveBusinessHours(id,btn){const ot=btn.innerText;btn.disabled=true;btn.innerText="Saving...";const fs=this.editState[id];const ob=this.data.businessHours.find(b=>b.id===id);const p={...ob,workingHours:fs};try{const v2=`${this.ctx.baseUrl}/organization/${this.ctx.orgId}/v2/business-hours/${id}`;let r=await fetch(v2,{method:"PUT",headers:{"Authorization":`Bearer ${this.ctx.token}`,"Content-Type":"application/json"},body:JSON.stringify(p)});if(r.status===404){const v1=`${this.ctx.baseUrl}/organization/${this.ctx.orgId}/business-hours/${id}`;r=await fetch(v1,{method:"PUT",headers:{"Authorization":`Bearer ${this.ctx.token}`,"Content-Type":"application/json"},body:JSON.stringify(p)})}if(!r.ok){const t=await r.text();throw new Error(`API Error ${r.status}: ${t}`)}ob.workingHours=JSON.parse(JSON.stringify(fs));this.hasChanges[id]=false;this.showNotification(`Saved "${ob.name}"`,"success");this.render()}catch(e){this.showNotification(`Save Failed: ${e.message}`,"error");btn.disabled=false;btn.innerText=ot}}async handleSaveVariable(id,btn){const i=this.shadowRoot.getElementById(`input-${id}`);let v=i.value;const ot=btn.innerText;btn.disabled=true;btn.innerText="...";const ov=this.data.variables.find(vb=>vb.id===id);const t=(ov.variableType||"").toLowerCase();if(t==="boolean")v=(v==="true");try{const u=`${this.ctx.baseUrl}/organization/${this.ctx.orgId}/cad-variable/${id}`;const p={...ov,id:id,defaultValue:v};const r=await fetch(u,{method:"PUT",headers:{"Authorization":`Bearer ${this.ctx.token}`,"Content-Type":"application/json"},body:JSON.stringify(p)});if(!r.ok)throw new Error(`Status ${r.status}`);ov.defaultValue=v;this.showNotification(`Saved "${ov.name}"`,"success")}catch(e){this.showNotification(`Error: ${e.message}`,"error")}finally{btn.disabled=false;btn.innerText=ot}}formatDays(d){if(!d||!d.length)return"No Days";if(d.length===7)return"Every Day";const m={SUN:0,MON:1,TUE:2,WED:3,THU:4,FRI:5,SAT:6};return[...d].sort((a,b)=>m[a]-m[b]).map(x=>x.substring(0,3)).join(", ")}formatTime(t){if(!t)return"";const[h,m]=t.split(":");const hr=parseInt(h,10);const ap=hr>=12?"PM":"AM";const h12=hr%12||12;return`${h12}:${m} ${ap}`}showNotification(m,t){const to=this.shadowRoot.getElementById("toast");to.innerText=m;to.className=`show ${t}`;setTimeout(()=>{to.className=to.className.replace("show","")},4000)}}if(!customElements.get("supervisor-controls")){customElements.define("supervisor-controls",SupervisorControls);console.log(`Supervisor Controls ${V} registered.`);}})();
